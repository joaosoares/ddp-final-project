#include "unity.h"
#include "../src/sw.h"
#include "testvector.h"

void test_MpAdd(void) {
  uint32_t a[32] = {0xf484e847, 0x4ae251f1, 0xedfa617d, 0x58ab6bf4, 0x46bf4848, 0xf67c1061, 0x8811c17a, 0x578fde16, 0x493ee595, 0x1eafc4c3, 0xc4f11a2e, 0x8cb6fba7, 0x724c03a4, 0x2e6c1dbd, 0x57ebc43d, 0x3e6ee260, 0x4089c050, 0xf0384e03, 0x7357f72c, 0x87acb658, 0x7ea2490e, 0x61069112, 0x42e3f8b9, 0x9e778cef, 0x5cdf77c7, 0x10bce41c, 0x1121beec, 0x3db59a36, 0xc34620c5, 0xc6b030ae, 0xe8fc5934, 0x63a0a0cb};
  uint32_t b[32] = {0xfeb1b9f4, 0xe91d3bec, 0xfb09354d, 0x07f21d6d, 0x9ece9e1b, 0x18def18b, 0x4119e1e9, 0x55c85f24, 0x60ef0e23, 0x10e8ab54, 0x1e95cdcc, 0x4373912f, 0x6f42204d, 0x7126650d, 0xb61c1c8d, 0x98af9011, 0xa42c03b4, 0xd29e0870, 0x7923cb60, 0xdf87cfe5, 0xde4fffa0, 0x3ce537ca, 0x201040c6, 0x6e54b058, 0x814c53dc, 0xf16243f0, 0x57decf64, 0x8d0d4f37, 0x9b6d93e5, 0x45396d71, 0x615213c4, 0x65f89f9f};
  uint32_t res[33];
  uint32_t expected[32] = {0xf336a23b, 0x33ff8dde, 0xe90396cb, 0x609d8962, 0xe58de663, 0x0f5b01ec, 0xc92ba364, 0xad583d3a, 0xaa2df3b8, 0x2f987017, 0xe386e7fa, 0xd02a8cd6, 0xe18e23f1, 0x9f9282ca, 0x0e07e0ca, 0xd71e7272, 0xe4b5c404, 0xc2d65673, 0xec7bc28d, 0x6734863d, 0x5cf248af, 0x9debc8dd, 0x62f4397f, 0x0ccc3d47, 0xde2bcba4, 0x021f280c, 0x69008e51, 0xcac2e96d, 0x5eb3b4aa, 0x0be99e20, 0x4a4e6cf9, 0xc999406b};
  
  // Mp addition
  mp_add(a, b, res, 32);

  // Assert
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}


void test_MpSubTest(void) {
  uint32_t a[32] = {0xf484e847, 0x4ae251f1, 0xedfa617d, 0x58ab6bf4, 0x46bf4848, 0xf67c1061, 0x8811c17a, 0x578fde16, 0x493ee595, 0x1eafc4c3, 0xc4f11a2e, 0x8cb6fba7, 0x724c03a4, 0x2e6c1dbd, 0x57ebc43d, 0x3e6ee260, 0x4089c050, 0xf0384e03, 0x7357f72c, 0x87acb658, 0x7ea2490e, 0x61069112, 0x42e3f8b9, 0x9e778cef, 0x5cdf77c7, 0x10bce41c, 0x1121beec, 0x3db59a36, 0xc34620c5, 0xc6b030ae, 0xe8fc5934, 0x63a0a0cb};
  uint32_t b[32] = {0xfeb1b9f4, 0xe91d3bec, 0xfb09354d, 0x07f21d6d, 0x9ece9e1b, 0x18def18b, 0x4119e1e9, 0x55c85f24, 0x60ef0e23, 0x10e8ab54, 0x1e95cdcc, 0x4373912f, 0x6f42204d, 0x7126650d, 0xb61c1c8d, 0x98af9011, 0xa42c03b4, 0xd29e0870, 0x7923cb60, 0xdf87cfe5, 0xde4fffa0, 0x3ce537ca, 0x201040c6, 0x6e54b058, 0x814c53dc, 0xf16243f0, 0x57decf64, 0x8d0d4f37, 0x9b6d93e5, 0x45396d71, 0x615213c4, 0x65f89f9f};
  uint32_t res[32];
  uint32_t expected[32] = {0xf5d32e53, 0x61c51604, 0xf2f12c2f, 0x50b94e86, 0xa7f0aa2d, 0xdd9d1ed5, 0x46f7df91, 0x01c77ef2, 0xe84fd772, 0x0dc7196e, 0xa65b4c62, 0x49436a78, 0x0309e357, 0xbd45b8b0, 0xa1cfa7af, 0xa5bf524e, 0x9c5dbc9b, 0x1d9a4592, 0xfa342bcc, 0xa824e672, 0xa052496d, 0x24215947, 0x22d3b7f3, 0x3022dc97, 0xdb9323eb, 0x1f5aa02b, 0xb942ef87, 0xb0a84afe, 0x27d88cdf, 0x8176c33d, 0x87aa4570, 0xfda8012c};

  mp_sub(a, b, res, 32);

  // Assert
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}

void test_MpSubTestZeros(void) {
  uint32_t a[2] = {0x00000002, 0x00000000};
  uint32_t b[2] = {0x00000002, 0x00000000};
  uint32_t res[2];
  uint32_t expected[2] = {0x00000000, 0x00000000};

  mp_sub(a, b, res, 2);

  // Assert
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 2);
}

void test_Mod(void) {
  uint32_t a[2] = {0x00000003, 0x00000000};
  uint32_t N[2] = {0x00000002, 0x00000000};
  uint32_t res[2];
  uint32_t expected[2] = {0x00000001, 0x00000000};
  mod(a, N, 2);
  // Assert
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, a, 2);
}

void test_ModAdd(void) {
  uint32_t a_mod_add[32] = {0xf484e847, 0x4ae251f1, 0xedfa617d, 0x58ab6bf4, 0x46bf4848, 0xf67c1061, 0x8811c17a, 0x578fde16, 0x493ee595, 0x1eafc4c3, 0xc4f11a2e, 0x8cb6fba7, 0x724c03a4, 0x2e6c1dbd, 0x57ebc43d, 0x3e6ee260, 0x4089c050, 0xf0384e03, 0x7357f72c, 0x87acb658, 0x7ea2490e, 0x61069112, 0x42e3f8b9, 0x9e778cef, 0x5cdf77c7, 0x10bce41c, 0x1121beec, 0x3db59a36, 0xc34620c5, 0xc6b030ae, 0xe8fc5934, 0x63a0a0cb};
  uint32_t b_mod_add[32] = {0xfeb1b9f4, 0xe91d3bec, 0xfb09354d, 0x07f21d6d, 0x9ece9e1b, 0x18def18b, 0x4119e1e9, 0x55c85f24, 0x60ef0e23, 0x10e8ab54, 0x1e95cdcc, 0x4373912f, 0x6f42204d, 0x7126650d, 0xb61c1c8d, 0x98af9011, 0xa42c03b4, 0xd29e0870, 0x7923cb60, 0xdf87cfe5, 0xde4fffa0, 0x3ce537ca, 0x201040c6, 0x6e54b058, 0x814c53dc, 0xf16243f0, 0x57decf64, 0x8d0d4f37, 0x9b6d93e5, 0x45396d71, 0x615213c4, 0x65f89f9f};
  uint32_t N_mod_add[32] = {0x4aeeb107, 0x5d78aa98, 0x6c55dd05, 0x6f5326c9, 0xf93f738c, 0xc10fa093, 0x20478120, 0x099d6d70, 0x833d9b82, 0x1248f3ed, 0xa43ed737, 0xc1c1da45, 0x9f23e5c7, 0xb17c3598, 0xe8938df6, 0x7ae59036, 0x9f84d87b, 0xc8710dc6, 0x249ee0f8, 0x46eeae2f, 0x66a3bb9b, 0xfeef4c6b, 0xc7b55eae, 0x7951dd0c, 0x0b4391e8, 0x141ad586, 0x1a568588, 0x908293dd, 0x472c0bea, 0x8d00abfe, 0xed17377f, 0x83a01efe};
  uint32_t res[33];
  uint32_t expected[32] = {0x751b6f3e, 0x857a4b04, 0x1f923ef6, 0x4a4d8570, 0x18d37986, 0xf382b6c6, 0xc17f5e6e, 0x53017a5b, 0xdae8ce03, 0xb725b795, 0xbe15ade2, 0xfa36103f, 0x1abc0b6e, 0x7a371399, 0xf0e95d21, 0x3d52ce1b, 0xb075e548, 0x184b7fb8, 0xfc53e858, 0xb141e7f4, 0x55fcb059, 0x9e6a1af3, 0xafb7ca9e, 0x1f0c6faf, 0x6230b2e4, 0x698fffd3, 0xd6ea08e7, 0xc6abf54f, 0xa892ce7a, 0xb3103b2b, 0x196c430b, 0x1ac4d8bd};
  mod_add(a_mod_add, b_mod_add, N_mod_add, res, 32);
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}

void test_ModSub(void) {
  uint32_t a[32] = {0xf484e847, 0x4ae251f1, 0xedfa617d, 0x58ab6bf4, 0x46bf4848, 0xf67c1061, 0x8811c17a, 0x578fde16, 0x493ee595, 0x1eafc4c3, 0xc4f11a2e, 0x8cb6fba7, 0x724c03a4, 0x2e6c1dbd, 0x57ebc43d, 0x3e6ee260, 0x4089c050, 0xf0384e03, 0x7357f72c, 0x87acb658, 0x7ea2490e, 0x61069112, 0x42e3f8b9, 0x9e778cef, 0x5cdf77c7, 0x10bce41c, 0x1121beec, 0x3db59a36, 0xc34620c5, 0xc6b030ae, 0xe8fc5934, 0x63a0a0cb};
  uint32_t b[32] = {0xfeb1b9f4, 0xe91d3bec, 0xfb09354d, 0x07f21d6d, 0x9ece9e1b, 0x18def18b, 0x4119e1e9, 0x55c85f24, 0x60ef0e23, 0x10e8ab54, 0x1e95cdcc, 0x4373912f, 0x6f42204d, 0x7126650d, 0xb61c1c8d, 0x98af9011, 0xa42c03b4, 0xd29e0870, 0x7923cb60, 0xdf87cfe5, 0xde4fffa0, 0x3ce537ca, 0x201040c6, 0x6e54b058, 0x814c53dc, 0xf16243f0, 0x57decf64, 0x8d0d4f37, 0x9b6d93e5, 0x45396d71, 0x615213c4, 0x65f89f9f};
  uint32_t N[32] = {0x4aeeb107, 0x5d78aa98, 0x6c55dd05, 0x6f5326c9, 0xf93f738c, 0xc10fa093, 0x20478120, 0x099d6d70, 0x833d9b82, 0x1248f3ed, 0xa43ed737, 0xc1c1da45, 0x9f23e5c7, 0xb17c3598, 0xe8938df6, 0x7ae59036, 0x9f84d87b, 0xc8710dc6, 0x249ee0f8, 0x46eeae2f, 0x66a3bb9b, 0xfeef4c6b, 0xc7b55eae, 0x7951dd0c, 0x0b4391e8, 0x141ad586, 0x1a568588, 0x908293dd, 0x472c0bea, 0x8d00abfe, 0xed17377f, 0x83a01efe};
  uint32_t res[32];
  uint32_t expected[32] = {0x40c1df5a, 0xbf3dc09d, 0x5f470934, 0xc00c7550, 0xa1301db9, 0x9eacbf69, 0x673f60b2, 0x0b64ec62, 0x6b8d72f4, 0x20100d5c, 0x4a9a2399, 0x0b0544be, 0xa22dc91f, 0x6ec1ee48, 0x8a6335a6, 0x20a4e285, 0x3be29517, 0xe60b5359, 0x1ed30cc4, 0xef1394a2, 0x06f60508, 0x2310a5b3, 0xea8916a2, 0xa974b9a3, 0xe6d6b5d3, 0x337575b1, 0xd399750f, 0x412adedb, 0x6f0498ca, 0x0e776f3b, 0x74c17cf0, 0x8148202b};

  // init_performance_counters(1);
  // uint32_t start_time = get_cycle_counter();
  // Mp addition
  mod_sub(a, b, N, res, 32);
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}


void test_MontMultiply1(void) {
  uint32_t a[32] = {0xf484e847, 0x4ae251f1, 0xedfa617d, 0x58ab6bf4, 0x46bf4848, 0xf67c1061, 0x8811c17a, 0x578fde16, 0x493ee595, 0x1eafc4c3, 0xc4f11a2e, 0x8cb6fba7, 0x724c03a4, 0x2e6c1dbd, 0x57ebc43d, 0x3e6ee260, 0x4089c050, 0xf0384e03, 0x7357f72c, 0x87acb658, 0x7ea2490e, 0x61069112, 0x42e3f8b9, 0x9e778cef, 0x5cdf77c7, 0x10bce41c, 0x1121beec, 0x3db59a36, 0xc34620c5, 0xc6b030ae,0xe8fc5934, 0x63a0a0cb};
  uint32_t b[32] = {0xfeb1b9f4, 0xe91d3bec, 0xfb09354d, 0x07f21d6d, 0x9ece9e1b, 0x18def18b, 0x4119e1e9, 0x55c85f24, 0x60ef0e23, 0x10e8ab54, 0x1e95cdcc, 0x4373912f, 0x6f42204d, 0x7126650d, 0xb61c1c8d, 0x98af9011, 0xa42c03b4, 0xd29e0870, 0x7923cb60, 0xdf87cfe5, 0xde4fffa0, 0x3ce537ca, 0x201040c6, 0x6e54b058, 0x814c53dc, 0xf16243f0, 0x57decf64, 0x8d0d4f37, 0x9b6d93e5, 0x45396d71,0x615213c4, 0x65f89f9f};
  uint32_t N[32] = {0x4aeeb107, 0x5d78aa98, 0x6c55dd05, 0x6f5326c9, 0xf93f738c, 0xc10fa093, 0x20478120, 0x099d6d70, 0x833d9b82, 0x1248f3ed, 0xa43ed737, 0xc1c1da45, 0x9f23e5c7, 0xb17c3598, 0xe8938df6, 0x7ae59036, 0x9f84d87b, 0xc8710dc6, 0x249ee0f8, 0x46eeae2f, 0x66a3bb9b, 0xfeef4c6b, 0xc7b55eae, 0x7951dd0c, 0x0b4391e8, 0x141ad586, 0x1a568588, 0x908293dd, 0x472c0bea, 0x8d00abfe,0xed17377f, 0x83a01efe};
  uint32_t n_prime[32] =  {0xe7d41349, 0x0c828dcd, 0x2dc06d90, 0x318f87bf, 0x1992ba09, 0x4b1bef10, 0x011ba664, 0xe3a7d9cf, 0x44449fbd, 0x89714d34, 0x6cd49cc4, 0x49c5b99d, 0xf90435b1, 0x38f037b7, 0xba9720db, 0x9641b106, 0xbca01d2a, 0xfdb82893, 0xbd7ce9c7, 0x372823e1, 0x4901cdde, 0xaa28d457, 0xe9f78c94, 0xb6e1e5b3, 0x5a79f7a6, 0xf5212a83, 0x2b1aab45, 0xa3924b69, 0x3c63a8af, 0x12fa121d, 0x7500bea0, 0xe58878e7};
  uint32_t expected[32] = {0xeb7e3ef3, 0x40b90c4f, 0xd9c234b1, 0x2461cd34, 0x183481c7, 0x0bc4e5bd, 0x4803996e, 0x755d1777, 0x698f88c7, 0x2e78b03b, 0xa55cfb32, 0x74d1c12a, 0xc6bc8934, 0x581d4714, 0x7d504a58, 0xb29753f1, 0x99ae0c37, 0x65c4cc3a, 0x4153aacb, 0xe0a5c4bf, 0xce0a9c7c, 0x4babfb22, 0x75aa490d, 0x43b6ec25, 0xdcb17a10, 0x47deec3c, 0xd0e2735f, 0x16726b8e, 0x0f486246, 0x0f74d471, 0xe62a3577, 0x065a0397};
  uint32_t res[32];

  montgomery_multiply(a, b, N, n_prime, res, 32);

  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}

void test_MontMultiply2(void) {
  uint32_t a[32] = {0x95401e33, 0xf2e5f538, 0xcd340e16, 0x5fe4fd66, 0xac500fe0, 0x748f18fe, 0xdad8575e, 0xce2058bb, 0x00c35266, 0xd51c8064, 0xfefeb38e, 0xc7ed29eb, 0xdb438313, 0x6550e48e, 0x02489732, 0xedaf8b6b, 0x5dd5313d, 0xa328f036, 0x419a784e, 0x23d635bb, 0x25143077, 0x48996382, 0xaa396499, 0xf24a2910, 0xb60ee4dc, 0xdfede44c, 0x69f174f6, 0x917d544c, 0x3c80aecf, 0xc90096c4,0xc52a6c88, 0x07d92c14};
  uint32_t b[32] = {0xd7040630, 0xc765f25a, 0x4a7230d6, 0x395c2b8b, 0xaec10e86, 0xb62173f6, 0x72096da0, 0xc0ed3b81, 0x240e4293, 0xac5a2199, 0x5d05fed8, 0xadcae3e6, 0x22704082, 0x3b74cdb2, 0x51f0df68, 0xde5b7e6f, 0x66dc5f67, 0x0a836d5e, 0x32edcdb9, 0x4332989f, 0xedef232c, 0x25167785, 0x34d884aa, 0xfdf337de, 0xd7532d14, 0xa4b160f1, 0xf833b81c, 0xaa9589fb, 0xef7f7ade, 0x6ccff27d,0x747a7bb0, 0x1f8042e7};
  uint32_t N[32] = {0xc6df4c85, 0x08e49be7, 0xe6f266e4, 0x450ca4b0, 0x028def7e, 0x3bdf79cf, 0xd3c65a9b, 0xd278192c, 0x08fd96bf, 0x5d635e17, 0xac3f28b1, 0x8449d487, 0xdd42688c, 0x61419fe8, 0x6b674328, 0x8f6bd9e2, 0x8e47420e, 0x94711c9e, 0x22f7165a, 0x2485755e, 0x61561df6, 0xf664e91d, 0xd97d05ce, 0xf221e0fd, 0xfd772f68, 0xf1856267, 0xe9041ac4, 0x2fd12fc8, 0x34b9220f, 0x695e5d77,0x6b079c2c, 0x86ad4952};
  uint32_t n_prime[32] =  {0x14d333b3, 0xc3b3be8f, 0x02ca4af0, 0xc43aba10, 0xde20e9cb, 0xc88222f9, 0x80860cc0, 0x315e4cf8, 0x0a2cc4f4, 0x16376d50, 0xcc1720b7, 0x8af0c35b, 0xc3ece9e9, 0x8f01dccc, 0x42d96568, 0xc02be3a4, 0x71e50c92, 0xb050887c, 0x4df93c3d, 0x75a13c65, 0xcd504fe2, 0x99ac5e4c, 0xc9f348e7, 0xb95f9a0e, 0xe170a1f0, 0x4769f246, 0x913001b4, 0xfc05df41, 0x63dc5efb, 0x9a863fbe, 0xc1f39f28, 0xf1295524};
  uint32_t expected[32] = {0xe4a627f2, 0x44ced61c, 0xb41445b2, 0x1deec41a, 0x00ec59c6, 0x366243e9, 0x8b3a5383, 0x293a279e, 0xb57482b8, 0x28a49995, 0xd5012ddd, 0xa1427bbf, 0xa4586c9c, 0x7df6bde0, 0x923e818c, 0xe215dbb8, 0x3a62ed6c, 0xe0f76529, 0x2d2936f3, 0x54e7fa14, 0x18022409, 0x6d5160c4, 0x998fe1c4, 0x86dab2c2, 0x46eda221, 0x6f93d1e2, 0xe9e57d26, 0xfb42688f, 0x679e9aa1, 0x6b70806a, 0x85d91b9f, 0x6a7decd7};
  uint32_t res[32];

  montgomery_multiply(a, b, N, n_prime, res, 32);
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}


void test_MontMultiply3(void) {
  uint32_t a[32] = {0x4b0afbba, 0xb3270d27, 0xfef81247, 0x9c028fde, 0x873a8d9d, 0x74150080, 0x21c3a9a5, 0x04b6f5a7, 0x465ab66a, 0xf0af88c6, 0x4210ad08, 0x3178b33b, 0x520fa2fe, 0xfabbcfe3, 0x51a66eb0, 0x1c1a6807, 0x57dc7837, 0x651c9e46, 0x21c0b44a, 0xaba36ace, 0x82f4820e, 0xf6a0e49f, 0xf489dab2, 0x93df7bae, 0x74203419, 0xbd13b6fd, 0x4135e9f9, 0x046d1052, 0xc0a7108c, 0x191a0cc0,0x607fc341, 0x2c261c9b};
  uint32_t b[32] = {0xf1d2b3e2, 0x925c0577, 0x825c7977, 0x0cc1e17c, 0x179e2466, 0x0abf48a4, 0x839b99e3, 0x7b52c351, 0xc643edb7, 0x51c28d81, 0xdb0242ba, 0x87069825, 0xb4e0aae5, 0x87b90b9b, 0x8026f877, 0xfd3b0911, 0x67498835, 0x9e56065e, 0x634a379e, 0xc2281d7e, 0x7793f6b9, 0x4a15cd7c, 0xd5d7c345, 0xdf354cd4, 0x5dfdb200, 0x2a7f0547, 0x88da4e10, 0xedf5af44, 0x2982780e, 0x8ac21ffd,0xb5118fec, 0x63a68886};
  uint32_t N[32] = {0x575bb461, 0x1a3042d4, 0x95d708c1, 0x9a02f06b, 0x7582491e, 0x947f45f7, 0x6b785070, 0xa35e54c5, 0xba07c851, 0x29fb66a2, 0xd893feb0, 0xa2ebe291, 0x08a64bd1, 0x5ab21338, 0xb451c21d, 0x330e7700, 0xa812c547, 0x633354b3, 0x9439c77f, 0x7de168b7, 0xd199da8f, 0x44fdd142, 0x8ce3e7f1, 0xb807a6ae, 0x5173de8c, 0xe2fe1c98, 0x4d51689c, 0x5cfa7887, 0x54f0f9b9, 0x4b71a0e2,0xbae33525, 0xb5d738a0};
  uint32_t n_prime[32] = {0x16f2105f, 0xfdddd2ad, 0x95f75ac0, 0xa8c30990, 0xf655e370, 0x8720517c, 0x886839eb, 0xabeb253b, 0xdb6a3b3a, 0x6bf8258a, 0x3a62d68d, 0x6a346d25, 0x208996eb, 0x217db098, 0xa2f73e93, 0x24b76402, 0xcd4545e4, 0x97a3727b, 0x7ab207b7, 0x913832ef, 0x9996349c, 0xda3718a1, 0xab631b76, 0x694a7470, 0x93cb8bfa, 0x408f5cc3, 0xd34ef659, 0x57aa7bc7, 0xa1a8404b, 0x6730f4f7, 0xbb489ebf, 0x401b0f1d};
  uint32_t expected[32] = {0xc60b461c, 0xa0b3d297, 0x36cdf567, 0xf61ba6f0, 0x5896f601, 0xb783bb66, 0xdbbe1d00, 0x09c51ceb, 0x0e815dc5, 0xbb2b3cd5, 0x8b1bc301, 0xd1537350, 0x2d2b3ca4, 0xa523a084, 0x8af15a07, 0xba3ee24e, 0xcf37d992, 0x994fb3f4, 0x851fe6c8, 0x5f0f7503, 0x64db0e7f, 0xbf345d0b, 0x270446f9, 0x40b1b03c, 0x105282ae, 0xba1be739, 0x391d873e, 0x01e17c2a, 0x29408bfe, 0x52a7b38f, 0x6e49fd28, 0x11d7e225};
  uint32_t res[32];

  montgomery_multiply(a, b, N, n_prime, res, 32);

  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}

void test_AddCarry(void) {
  uint32_t t[4] = {0xffffffff, 0x00000000, 0xffffffff, 0x00001212};
  uint32_t index = 0;
  uint32_t c = 0x0000ffff;
  uint32_t expected[4] = {0x0000fffe, 0x00000001, 0xffffffff, 0x00001212};

  add_carry(t, index, c);

  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, t, 4);
}

void test_ModExp(void) {
  uint32_t x[32] = {0x7e4d114f, 0xcdcc53e9, 0xec875fef, 0xd4801e7e, 0x63951386, 0xc53baeeb, 0x4d92fcec, 0xbcdd23af, 0xb7dbbcbb, 0x2581853f, 0x5e84c0ac, 0xa99d8077, 0x1c6d04e9, 0x525d5ad6, 0x718dbfcb, 0x3e69c71b, 0x0382a78a, 0xb3910f7e, 0xffc533fd, 0x67392a6e, 0x79f1ea16, 0xac3054aa, 0xb4f2b561, 0x949e7f5d, 0x4a047fad, 0x1b34d4d6, 0x4ac73a27, 0x62c6176e, 0x7f8dbd39, 0x6e831c04, 0x91a4bd57, 0xd3948540};
  uint32_t e[32] = {0x00008aa7};
  uint32_t n[32] = {0x79c5095d, 0x4fd29542, 0xd9315b45, 0x4c4a72d2, 0x04f9addb, 0x90ff37b2, 0xbc79bc4d, 0xcf6df0c2, 0x04bf4901, 0xb49ba798, 0x4f448e34, 0xcf173a56, 0x11b530c1, 0xae8bf2c0, 0xfd0f3441, 0xbf1feed8, 0x060e1237, 0x56867970, 0x2fcaa42a, 0x0610f853, 0xfe44cce7, 0x682cf637, 0x3885d4c7, 0x84e0b594, 0x5b9a2c0d, 0xf76f70d2, 0x75f5ed7a, 0x838f187b, 0x207bedda, 0xeba321a7, 0x57f41ea0, 0xe463552f};
  uint32_t n_prime[32] = {0xc8fc6d0b, 0x3b9528be, 0x588c68c6, 0xb9b850ce, 0x8f551fc2, 0x9f18d39f, 0x501f1c39, 0x0ed0b2e0, 0x717ef88d, 0xc702a27e, 0xcc171e91, 0xd0273bc0, 0xb9edc961, 0x8b18b90f, 0x9f1d542e, 0xe11063f4, 0xafca451d, 0x253aef1a, 0xef6cc8b3, 0xe631f664, 0xa8fffbdb, 0x755130cf, 0x68e5940d, 0x9b251525, 0xb160ecc4, 0x043f2d9a, 0xb9d37e55, 0x9169ad33, 0x1025523a, 0x87d6b39f, 0x4d09220f, 0x965055a2};
  uint32_t r2m[32] = {0xe7b68710, 0x454aa8c5, 0x8fdb095d, 0x68d3ed7f, 0xc27518eb, 0xdeac4c5c, 0x88a56cef, 0x2b628d76, 0xffce81bb, 0x6a8bd32f, 0x75279c61, 0x828feaca, 0xa73082e7, 0x4d9c2014, 0x4dfcdb2c, 0x29384d96, 0xecd832ff, 0x3389f036, 0x610c12d8, 0xfb240fb6, 0x3aed1f10, 0xd0a30182, 0x99780866, 0x108da0c5, 0x5a3c21ed, 0xaf206ce9, 0x65e10666, 0x51857998, 0x21ec37a4, 0x2b180b75, 0x0912c6f5, 0x4a53bab8};
  uint32_t rm[32] = {0x863af6a3, 0xb02d6abd, 0x26cea4ba, 0xb3b58d2d, 0xfb065224, 0x6f00c84d, 0x438643b2, 0x30920f3d, 0xfb40b6fe, 0x4b645867, 0xb0bb71cb, 0x30e8c5a9, 0xee4acf3e, 0x51740d3f, 0x02f0cbbe, 0x40e01127, 0xf9f1edc8, 0xa979868f, 0xd0355bd5, 0xf9ef07ac, 0x01bb3318, 0x97d309c8, 0xc77a2b38, 0x7b1f4a6b, 0xa465d3f2, 0x08908f2d, 0x8a0a1285, 0x7c70e784, 0xdf841225, 0x145cde58, 0xa80be15f, 0x1b9caad0};
  uint32_t expected[32] = {0x24d9ba1b, 0xcdee03d4, 0x24fc9e9e, 0x2a2bb53e, 0xe95c5ac0, 0xe6c4a7b4, 0x288bf152, 0xb3e2e968, 0x8cd38315, 0x5dd50ee8, 0x75d2f5ed, 0xb768e0ee, 0x1ecf4f44, 0x8f052e68, 0x77e5949b, 0x914dfa11, 0xbfac47ca, 0xc1c76ad0, 0x46f6afae, 0x1c1bcbb6, 0x0a151783, 0xfede6091, 0x4209c519, 0x4dcc11b3, 0x0c28d052, 0xa9e9b09b, 0x38b281f8, 0xd1b1b7ed, 0x12c11233, 0x1c1b7061, 0xb2e04da7, 0x3e446770};
  uint32_t res[32];

  mod_exp(x, e, 16, n, n_prime, r2m, rm, res, 32);
  TEST_ASSERT_EQUAL_HEX32_ARRAY(expected, res, 32);
}

